<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown 解析器测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">Markdown 转 HTML 解析器测试</h1>
        
        <div class="grid grid-cols-2 gap-8">
            <!-- 左侧：Markdown 输入 -->
            <div>
                <h2 class="text-xl font-bold mb-3">Markdown 源文本</h2>
                <textarea id="markdown-input" class="w-full h-96 p-4 border-2 border-slate-300 rounded-lg font-mono text-sm" placeholder="输入 Markdown 文本...">### 期刊综合分析
#### 内容前沿性分析
类型：前沿型期刊
解释：根据提供的指标数据，期刊在 **novelty**（新颖性）和 **disruptiveness**（颠覆性）上的得分较高，特别是 `innovationMatch`（创新匹配度）达到80，表明该期刊重视研究的新颖和颠覆性。

#### 学科开放性分析
类型：跨学科性较强的期刊
解释：期刊的 **interdisciplinarity**（跨学科性）得分为75，表明该期刊在学科交叉方面有一定的开放性。

### 匹配建议
#### 研究创新性匹配
具体匹配点：用户的创新类型（C级）与期刊在创新匹配度（80）相匹配。
理由：期刊重视研究的新颖和颠覆性，与用户的研究创新程度相契合。</textarea>
            </div>
            
            <!-- 右侧：HTML 输出 -->
            <div>
                <h2 class="text-xl font-bold mb-3">HTML 渲染结果</h2>
                <div id="html-output" class="w-full h-96 p-4 border-2 border-slate-300 rounded-lg overflow-y-auto bg-white"></div>
            </div>
        </div>
        
        <button id="convert-btn" class="mt-6 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            转换为 HTML
        </button>
    </div>

    <script>
        // Markdown 转 HTML 的完整解析器
        function markdownToHtml(markdown) {
            if (!markdown || typeof markdown !== 'string') return '';
            
            let html = markdown;
            
            // 1. 处理代码块（``` ... ```）
            html = html.replace(/```[\s\S]*?```/g, function(match) {
                const code = match.replace(/```/g, '').trim();
                return '<pre class="bg-slate-800 text-slate-100 p-4 rounded-lg overflow-x-auto mb-3"><code class="font-mono text-sm">' + 
                       escapeHtml(code) + '</code></pre>';
            });
            
            // 2. 处理四级标题 ####
            html = html.replace(/^#### (.+?)$/gm, 
                '<h5 class="text-base font-bold text-primary mt-3 mb-2 border-l-4 border-primary pl-3">$1</h5>');
            
            // 3. 处理三级标题 ###
            html = html.replace(/^### (.+?)$/gm, 
                '<h4 class="text-lg font-bold text-slate-800 mt-5 mb-3 pb-2 border-b-2 border-primary">$1</h4>');
            
            // 4. 处理二级标题 ##
            html = html.replace(/^## (.+?)$/gm, 
                '<h3 class="text-xl font-bold text-slate-900 mt-6 mb-4">$1</h3>');
            
            // 5. 处理一级标题 #
            html = html.replace(/^# (.+?)$/gm, 
                '<h2 class="text-2xl font-bold text-slate-900 mt-7 mb-4">$1</h2>');
            
            // 6. 处理加粗 **text** 或 __text__
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold text-slate-800">$1</strong>');
            html = html.replace(/__(.+?)__/g, '<strong class="font-semibold text-slate-800">$1</strong>');
            
            // 7. 处理斜体 *text* 或 _text_（但不匹配已处理的 **）
            html = html.replace(/(?<!\*)\*(?!\*)(.+?)(?!\*)\*(?!\*)/g, '<em class="italic text-slate-700">$1</em>');
            html = html.replace(/(?<!_)_(?!_)(.+?)(?<!_)_(?!_)/g, '<em class="italic text-slate-700">$1</em>');
            
            // 8. 处理行内代码 \`code\`
            html = html.replace(/`(.+?)`/g, 
                '<code class="bg-slate-100 text-red-600 px-2 py-0.5 rounded font-mono text-sm">$1</code>');
            
            // 9. 处理有序列表 1. 2. 等
            html = html.replace(/^\d+\. (.+?)$/gm, 
                '<li class="ml-6 text-slate-700 marker:text-primary">$1</li>');
            
            // 10. 处理无序列表 - 或 *
            html = html.replace(/^[\-\*] (.+?)$/gm, 
                '<li class="ml-6 text-slate-700">$1</li>');
            
            // 11. 将连续的 <li> 包装在 <ul> 或 <ol> 中
            html = html.replace(/(<li[^>]*>[\s\S]*?<\/li>\n?)+/g, function(match) {
                const isOrdered = match.includes('marker:');
                const wrapper = isOrdered ? 'ol' : 'ul';
                return '<' + wrapper + ' class="space-y-1 mb-3 list-inside">' + match.trim() + '</' + wrapper + '>';
            });
            
            // 12. 处理分割线 ---
            html = html.replace(/^---$/gm, '<hr class="border-slate-300 my-4">');
            
            // 13. 处理换行和空行
            let lines = html.split('\n');
            let result = [];
            let inList = false;
            let inCodeBlock = false;
            
            for (let line of lines) {
                line = line.trim();
                
                if (line.startsWith('<pre')) inCodeBlock = true;
                if (line.endsWith('</pre>')) inCodeBlock = false;
                
                if (inCodeBlock) {
                    result.push(line);
                } else if (line === '') {
                    // 空行处理
                    if (!inList && result.length > 0 && !result[result.length - 1].endsWith('</div>')) {
                        result.push('<div class="h-2"></div>');
                    }
                } else if (line.startsWith('<ol') || line.startsWith('<ul')) {
                    inList = true;
                    result.push(line);
                } else if (line.endsWith('</ol>') || line.endsWith('</ul>')) {
                    inList = false;
                    result.push(line);
                } else if (line.startsWith('<h') || line.startsWith('<pre') || line.startsWith('<hr')) {
                    result.push(line);
                } else if (line.startsWith('<li')) {
                    result.push(line);
                } else if (!inList && line && !line.startsWith('<') && line.length > 0) {
                    // 普通段落
                    result.push('<p class="text-slate-700 leading-relaxed mb-2">' + line + '</p>');
                } else if (line) {
                    result.push(line);
                }
            }
            
            html = result.join('\n');
            
            // 14. 清理过多的空 div
            html = html.replace(/<div class="h-2"><\/div>\n<div class="h-2"><\/div>/g, '<div class="h-2"></div>');
            
            return html;
        }
        
        // HTML 转义函数，防止 XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 事件监听
        document.getElementById('convert-btn').addEventListener('click', function() {
            const markdown = document.getElementById('markdown-input').value;
            const html = markdownToHtml(markdown);
            document.getElementById('html-output').innerHTML = html;
        });

        // 页面加载时转换一次
        window.addEventListener('load', function() {
            const markdown = document.getElementById('markdown-input').value;
            const html = markdownToHtml(markdown);
            document.getElementById('html-output').innerHTML = html;
        });
    </script>
</body>
</html>
